#!/usr/bin/env bash
# This script installs Cursor configuration files to OS-specific locations
# It runs after chezmoi apply to handle OS-specific paths that chezmoi can't manage directly

set -euo pipefail

# Determine OS-specific Cursor config directory
if [[ "$(uname -s)" == "Darwin" ]]; then
    CURSOR_CONFIG_DIR="$HOME/Library/Application Support/Cursor/User"
else
    CURSOR_CONFIG_DIR="$HOME/.config/Cursor/User"
fi

# Create directory if it doesn't exist
mkdir -p "$CURSOR_CONFIG_DIR"

# Source files in chezmoi repo
CHEZMOI_SOURCE_DIR="{{ .chezmoi.sourceDir }}"
SETTINGS_SOURCE="$CHEZMOI_SOURCE_DIR/private_dot_config/private_Cursor/User/private_settings.json"
EXTENSIONS_SOURCE="$CHEZMOI_SOURCE_DIR/private_dot_config/private_Cursor/User/extensions.json"

# Target files
SETTINGS_TARGET="$CURSOR_CONFIG_DIR/settings.json"
EXTENSIONS_TARGET="$CURSOR_CONFIG_DIR/extensions.json"

# Function to install a file
install_file() {
    local source="$1"
    local target="$2"

    if [[ ! -f "$source" ]]; then
        return 0  # Source doesn't exist, skip
    fi

    # Remove existing symlink or file if it exists
    [[ -L "$target" ]] && rm "$target"
    [[ -f "$target" && ! -L "$target" ]] && rm "$target"

    # Create symlink
    ln -sf "$source" "$target"
    chmod 600 "$target"
    echo "âœ“ Linked $target -> $source"
}

# Install both files
install_file "$SETTINGS_SOURCE" "$SETTINGS_TARGET"
install_file "$EXTENSIONS_SOURCE" "$EXTENSIONS_TARGET"
